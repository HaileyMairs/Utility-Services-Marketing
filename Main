#11:35am 11/12/25
#Automatically build gui
import os
import re
import importlib.util
import tkinter as tk
from tkinter import ttk

# ---------- CONFIG ----------
PY_FOLDER = os.path.join(os.getcwd(), "Functions")  # folder containing modules
BG_BLACK = "#000000"
CREAM = "#FFF8E1"
DARK_GREEN = "#0b5d3b"
PANEL_BG = "#0f0f0f"

# ---------- SCAN PY FILES ----------
def scan_py_files(folder):
    """Scan .py files for # title and #btn comments at the top."""
    menu_data = {}
    for fname in os.listdir(folder):
        if not fname.endswith(".py"):
            continue
        path = os.path.join(folder, fname)
        try:
            with open(path, "r", encoding="utf-8") as f:
                lines = f.readlines()
        except Exception:
            continue

        current_title = None
        for line in lines:
            line = line.strip()
            if not line.startswith("#"):
                break  # stop at first non-comment line

            title_match = re.match(r"#\s*title:\s*'([^']+)'", line)
            btn_match = re.match(r"#\s*btn:\s*'([^']+)'", line)

            if title_match:
                current_title = title_match.group(1)
                menu_data.setdefault(current_title, [])
            elif btn_match and current_title:
                btn_name = btn_match.group(1)
                if not any(btn_name == b[0] for b in menu_data[current_title]):
                    menu_data[current_title].append((btn_name, fname))
    return menu_data

# ---------- MAIN APP ----------
class DynamicUtilityApp:
    def __init__(self, folder):
        self.folder = folder
        self.modules = {}  # cache imported modules

        # Tkinter GUI setup
        self.gui = tk.Tk()
        self.gui.title("Dynamic Utility App")
        self.gui.state("zoomed")
        self.gui.configure(bg=BG_BLACK)

        # Sidebar
        self.sidebar = tk.Frame(self.gui, bg=PANEL_BG, width=220)
        self.sidebar.pack(side="left", fill="y")
        self.sidebar.pack_propagate(False)

        # Menu label at top
        tk.Label(
            self.sidebar,
            text="Menu",
            font=("Segoe UI", 14, "bold"),
            bg=PANEL_BG,
            fg=CREAM
        ).pack(pady=(16, 8))

        # Main panel
        self.main_frame = tk.Frame(self.gui, bg=BG_BLACK)
        self.main_frame.pack(side="left", fill="both", expand=True, padx=8, pady=8)
        self.title_label = tk.Label(self.main_frame, text="", fg=CREAM, bg=BG_BLACK, font=("Segoe UI", 18, "bold"))
        self.title_label.pack(fill="x", pady=(0,5))

        # Treeview
        self.tree_frame = ttk.Frame(self.main_frame)
        self.tree_frame.pack(fill="both", expand=True)
        self.tree = ttk.Treeview(self.tree_frame, columns=(), show="headings")
        self.tree.pack(side="left", fill="both", expand=True)
        scrollbar = ttk.Scrollbar(self.tree_frame, orient="vertical", command=self.tree.yview)
        scrollbar.pack(side="right", fill="y")
        self.tree.configure(yscrollcommand=scrollbar.set)

        # Setup styles
        self.setup_styles()

        # Build sidebar dynamically
        self.build_dynamic_sidebar()

    # ---------- STYLES ----------
    def setup_styles(self):
        style = ttk.Style(self.gui)
        style.theme_use('clam')

        # Treeview overall
        style.configure("Treeview",
                        background=BG_BLACK,
                        fieldbackground=BG_BLACK,
                        foreground=CREAM,
                        rowheight=28,
                        font=("Segoe UI", 10))
        style.configure("Treeview.Heading",
                        background=DARK_GREEN,
                        foreground=CREAM,
                        font=("Segoe UI", 10, "bold"))
        style.map("Treeview",
                  background=[('selected', '#1a7b50')],
                  foreground=[('selected', 'white')])
        style.map("Treeview.Heading",
                  background=[('active', '#1a7b50')],
                  foreground=[('active', CREAM)])

    # ---------- DYNAMIC SIDEBAR ----------
    def build_dynamic_sidebar(self):
        data = scan_py_files(self.folder)
        for title, btn_list in data.items():
            main_btn = tk.Button(self.sidebar, text=f"{title} ▸", bg=DARK_GREEN, fg=CREAM, relief="flat", anchor="w")
            main_btn.pack(fill="x", padx=12, pady=6)

            frame = tk.Frame(self.sidebar, bg=PANEL_BG)
            frame.pack(fill="x", padx=0, pady=0)
            frame.pack_forget()

            # toggle collapse/expand
            def toggle(f=frame, b=main_btn, t=title):
                if f.winfo_ismapped():
                    f.pack_forget()
                    b.config(text=f"{t} ▸")
                else:
                    f.pack(fill="x")
                    b.config(text=f"{t} ▾")
            main_btn.config(command=toggle)

            for btn_name, module_file in btn_list:
                mod_instance = self.load_module(module_file)
                tk.Button(
                    frame,
                    text=btn_name,
                    bg=PANEL_BG,
                    fg=CREAM,
                    relief="flat",
                    anchor="w",
                    activebackground=DARK_GREEN,
                    activeforeground=CREAM,
                    command=lambda m=mod_instance, b=btn_name: self.call_module_function(m, b)
                ).pack(fill="x", pady=2, padx=24)  

    # ---------- MODULE HANDLING ----------
    def load_module(self, filename):
        if filename in self.modules:
            return self.modules[filename]
        path = os.path.join(self.folder, filename)
        spec = importlib.util.spec_from_file_location(filename[:-3], path)
        module = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(module)
        # Look for a class in the module (assumes one main class ending with 'Utility')
        cls = None
        for attr in dir(module):
            if attr.endswith("Utility"):
                cls = getattr(module, attr)
                break
        if cls:
            instance = cls()
            self.modules[filename] = instance
            return instance
        self.modules[filename] = module
        return module

    def call_module_function(self, module_instance, btn_name):
        method_name = btn_name.lower()
        if hasattr(module_instance, method_name):
            func = getattr(module_instance, method_name)
            try:
                cols, rows = func()
            except TypeError:
                cols, rows = ("Data",), []
            self.populate_tree(rows, cols)
            self.title_label.config(text=btn_name)
        else:
            self.title_label.config(text=f"Function '{method_name}' not found")

    # ---------- TREEVIEW POPULATE ----------
    def populate_tree(self, rows, cols):
        tree = self.tree
        tree.delete(*tree.get_children())
        tree["columns"] = cols
        tree["show"] = "headings"

        for c in cols:
            tree.heading(c, text=c, anchor="center")
            tree.column(c, width=150, anchor="center")

        if not rows:
            tree["columns"] = ("Message",)
            tree.heading("Message", text="")
            tree.column("Message", anchor="center", width=800)
            tree.insert("", "end", values=("⚠️ No data found.",))
            return

        for i, r in enumerate(rows):
            tag = "evenrow" if i % 2 == 0 else "oddrow"
            tree.insert("", "end", values=r, tags=(tag,))

        tree.tag_configure("evenrow", background=BG_BLACK, foreground=CREAM)
        tree.tag_configure("oddrow", background="#0f0f0f", foreground=CREAM)

# ---------- RUN ----------
if __name__ == "__main__":
    app = DynamicUtilityApp(PY_FOLDER)
    app.gui.mainloop()
